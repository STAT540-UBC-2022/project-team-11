
Load packages
```{r message=FALSE,warning=FALSE}
suppressPackageStartupMessages(library("tidyverse"))
suppressPackageStartupMessages(library("GEOquery"))
suppressPackageStartupMessages(library("limma"))
suppressPackageStartupMessages(library("DESeq2"))
suppressPackageStartupMessages(library("edgeR"))
```


```{r}
eset <- getGEO("GSE152075", getGPL = FALSE)[[1]]
getGEOSuppFiles("GSE152075")
raw_counts <- read.csv("GSE152075/GSE152075_raw_counts_GEO.txt", sep = "")
count_mat <- as.matrix(raw_counts,row.names="gene_id")
```

```{r}
pdata <- eset@phenoData@data %>% as_tibble()
pdata_mod <- pdata %>%
  select(title, `age:ch1`, characteristics_ch1.3, characteristics_ch1.4, `sars-cov-2 positivity:ch1`) %>%
  subset(`age:ch1` != "Unknown") %>%
  transform(`age:ch1` = as.numeric(`age:ch1`))

colnames(pdata_mod) = c("Title", "Age", "Gender", "Batch", "Sars_test")
pdata_mod[is.na(pdata_mod)] <- 90

pdata_mod = pdata_mod %>%
  mutate(Age_category =  case_when(
    Age < 18 ~ "Child",
    Age >= 18 & Age < 35 ~ "Young Adult",
    Age >= 35 & Age < 65  ~ "Adult",
    TRUE ~ "Senior"
  ))

data = pdata %>%
       select(title, `age:ch1`) %>% 
       subset(`age:ch1` == "Unknown")

drop <- data$title
count_mat_final  = count_mat[,!colnames(count_mat) %in% drop]
```

```{r}
dge <- DGEList(counts = count_mat_final, samples = pdata_mod, group = pdata_mod$sarstest)
dim(dge)
apply(dge$counts, 2, sum) # total gene counts per sample

keep <- rowSums(cpm(dge)>100) >= 50
dge_mod <- dge[keep,]
dim(dge_mod)

dge$samples$lib.size <- colSums(dge$counts) # Reset library sizes
```

