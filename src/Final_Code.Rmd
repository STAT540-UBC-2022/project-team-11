---
title: "Final DE Analysis"
author: "Credo Casmil, Aditi Nagaraj Nallan, Ekpereka Amutaigwe and Dollina Dodani"  
date: '2022-03-20'
output: github_document
editor_options: 
  chunk_output_type: console
---

# Load packages

```{r message=FALSE,warning=FALSE}
suppressPackageStartupMessages(library(tidyverse))
suppressPackageStartupMessages(library(GEOquery))
suppressPackageStartupMessages(library(limma))
suppressPackageStartupMessages(library(edgeR))
suppressPackageStartupMessages(library(pheatmap))
suppressPackageStartupMessages(library(statmod))
suppressPackageStartupMessages(library(ggrepel))
suppressPackageStartupMessages(library(ggbiplot))
suppressPackageStartupMessages(library(ggplot2))
suppressPackageStartupMessages(library(caTools)) ## used for splitting the data into training and validation sets 
suppressPackageStartupMessages(library(caret)) ## used for confusion matrix, accuracy, sensitivity, and specificity
suppressPackageStartupMessages(library(mice))
suppressPackageStartupMessages(library(VIM))
suppressPackageStartupMessages(library(sva))
```

```{r}
## Setting work directory to save plots 
setwd(getwd())
```

```{r, warning=FALSE, message=FALSE, results='hide'}
eset <- getGEO("GSE152075", getGPL = FALSE)[[1]]
getGEOSuppFiles("GSE152075")

#Read in the count matrix
raw_counts <- read.csv("GSE152075/GSE152075_raw_counts_GEO.txt", sep = "")
count_mat <- as.matrix(raw_counts,row.names="gene_id")
```

```{r}
#Read in the metadata
pdata <- eset@phenoData@data %>% as_tibble()

#Clean the metadata to include only columns of interest for the initial analysis
pdata_clean = pdata %>%
  select(title, `age:ch1`, characteristics_ch1.3, characteristics_ch1.4, `sars-cov-2 positivity:ch1`, `n1_ct:ch1`)
colnames(pdata_clean) = c("Title", "Age", "Gender", "Batch", "Sars_test", "Viral_load")

pdata_clean$Gender = sapply(strsplit(pdata_clean$Gender, split=':', fixed=TRUE), function(x) (x[2]))
pdata_clean$Batch = sapply(strsplit(pdata_clean$Batch, split=':', fixed=TRUE), function(x) (x[2]))

#Modify the cleaned data set as per further DE analysis
pdata_mod <- pdata_clean %>%
  transform(Age = as.numeric(Age))

pdata_mod[is.na(pdata_mod)] <- 90
pdata_mod <- within(pdata_mod, Age[Age == 90 & Viral_load == 'Unknown'] <- "Not Collected")


pdata_mod = pdata_mod %>%
  mutate(Age_category =  case_when(
    Age < 18 ~ "Child",
    Age >= 18 & Age < 35 ~ "Young Adult",
    Age >= 35 & Age < 65  ~ "Adult",
    TRUE ~ "Senior"
  )) 

pdata_mod <- within(pdata_mod, Age_category[Age_category == "Senior" & Viral_load == "Unknown"] <- "Not Collected")

convert = c("Age_category", "Gender", "Sars_test", "Batch")
pdata_mod[convert] <- lapply(pdata_mod[convert], factor)
levels(pdata_mod$Gender)[3] <- "Not Collected"
```

```{r}
#Data modification for Imputation
data <- within(pdata_mod, Age[Age == 90 & Viral_load == 'Unknown'] <- NA)
data$Viral_load[data$Viral_load == "Unknown"] <- NA
data <- within(pdata_mod, Age_category[Age_category == "Senior" & Viral_load == "Unknown"] <- NA)
levels(data$Gender)[3] <- NA

#Data Imputation
mice_plot <- aggr(data, col=c('navyblue','yellow'),
                    numbers=TRUE, sortVars=TRUE,
                    labels=names(data), cex.axis=.7,
                    gap=3, ylab=c("Missing data","Pattern"))

imputed_Data <- mice(data, m=5, maxit = 50, method = 'pmm', seed = 500)
summary(imputed_Data)
#Check imputed values
imputed_Data$imp$Age
pdata_imputed <- complete(imputed_Data,3)
```

```{r}
age_groups <- c(pdata_imputed$Age_category)
sex <- c(pdata_imputed$Gender)
cov_test <- c(pdata_imputed$Sars_test)

Batches = as.character(pdata_imputed$Batch)

covariate_matrix1 <- cbind(cov_test, sex)
covariate_matrix2 <- cbind(cov_test, age_groups)
covariate_matrix3 <- cbind(age_groups, sex)


corrected_data1 <- ComBat_seq(counts = count_mat, batch = Batches, covar_mod = covariate_matrix1)
corrected_data2 <- ComBat_seq(counts = count_mat, batch = Batches, covar_mod = covariate_matrix2)
corrected_data3 <- ComBat_seq(counts = count_mat, batch = Batches, covar_mod = covariate_matrix3)

dim(count_mat)
dim(corrected_data1)
dim(corrected_data2)
dim(corrected_data2)

```

```{r}
#Creating DGE List 
dge <- DGEList(counts = corrected_data1, samples = pdata_imputed)
dim(dge)
head(apply(dge$counts, 2, sum)) # total gene counts per sample

#removing lowly expressed genes
keep_edge <- rowSums(cpm(dge)>100) >= 50
dge_mod <- dge[keep_edge,]
dim(dge_mod)

```

```{r, results='hide'}
# Reset library sizes
dge$samples$lib.size <- colSums(dge$counts) 
```


```{r}
#Calculating TMM normalization factors and directly adding them to the DGEList
dge_norm = calcNormFactors(dge_mod, method = "TMM")

#cpm and log transformation after adding a pseudo-count
cpm = cpm(dge_norm, log = FALSE, normalized.lib.sizes = TRUE)
log2cpm = log2(cpm + 1)
```

```{r}
#Setting up model matrix
designMatrix1 = model.matrix(~Sars_test*Age_category, data = dge_norm$samples) 
colnames(designMatrix1)
designMatrix1 <- designMatrix1[,-8]

designMatrix2 = model.matrix(~Sars_test*Gender, data = dge_norm$samples) 
colnames(designMatrix2)

designMatrix3 = model.matrix(~Gender*Age_category, data = dge_norm$samples) 
colnames(designMatrix3)
designMatrix3 <- designMatrix3[,-7]
```

```{r}
#Estimating dispersion parameters for each tag
dge_disp1 <- estimateDisp(dge_norm, designMatrix1, robust = TRUE) 
range(dge_disp1$prior.df)
plotBCV(dge_disp1,  cex=0.5)

lfit1 <- glmFit(dge_disp1, designMatrix1)
lrt1 <- glmLRT(lfit1)
toptags1 <- topTags(lrt1)$table %>% signif(3)

#Filtering for up and downregulated genes
lrt1_filter_upreg <- filter(lrt1$table, PValue < 0.05, logFC >1)
dim(lrt1_filter_upreg)
lrt1_filter_downreg <- filter(lrt1$table, PValue < 0.05, logFC < -1)
dim(lrt1_filter_downreg)

de1 <- decideTestsDGE(lrt1, adjust.method="BH", p.value = 0.05)
de1tags1 <- rownames(dge_disp1)[as.logical(de2)]
plotSmear(lrt1, de.tags=de1tags1)
de1_summary <- summary(de1)
de1_summary
```

```{r}
#Estimating dispersion parameters for each tag
dge_disp2 <- estimateDisp(dge_norm, designMatrix2, robust = TRUE) 
range(dge_disp2$prior.df)
plotBCV(dge_disp2,  cex=0.5)

lfit2 <- glmFit(dge_disp2, designMatrix2)
lrt2 <- glmLRT(lfit2)
toptags2 <- topTags(lrt2)$table %>% signif(3)

#Filtering for up and downregulated genes
lrt2_filter_upreg <- filter(lrt2$table, PValue < 0.05, logFC >1)
dim(lrt2_filter_upreg)
lrt2_filter_downreg <- filter(lrt2$table, PValue < 0.05, logFC < -1)
dim(lrt2_filter_downreg)

de2 <- decideTestsDGE(lrt2, adjust.method="BH", p.value = 0.05)
de1tags2 <- rownames(dge_disp2)[as.logical(de2)]
plotSmear(lrt2, de.tags=de1tags2)
de2_summary <- summary(de1)
de2_summary
```


```{r}
#Estimating dispersion parameters for each tag
dge_disp3 <- estimateDisp(dge_norm, designMatrix3, robust = TRUE) 
range(dge_disp3$prior.df)
plotBCV(dge_disp3,  cex=0.5)

lfit3 <- glmFit(dge_disp3, designMatrix2)
lrt3 <- glmLRT(lfit3)
toptags3 <- topTags(lrt3)$table %>% signif(3)

#Filtering for up and downregulated genes
lrt3_filter_upreg <- filter(lrt3$table, PValue < 0.05, logFC >1)
dim(lrt3_filter_upreg)
lrt3_filter_downreg <- filter(lrt3$table, PValue < 0.05, logFC < -1)
dim(lrt3_filter_downreg)

de3 <- decideTestsDGE(lrt3, adjust.method="BH", p.value = 0.05)
de1tags3 <- rownames(dge_disp3)[as.logical(de2)]
plotSmear(lrt3, de.tags=de1tags3)
de3_summary <- summary(de3)
de3_summary
```
